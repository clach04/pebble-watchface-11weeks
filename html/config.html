<!DOCTYPE html>
<html>
  <head>
  <title>11 Weeks Configuration</title>
  <meta charset='UTF-8' />
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.min.js'></script>
  <script src='js/anim-lib.js'></script>
  <script src='js/watch-11w.js'></script>
  <style>
  .hide {
    display: none;
  }

  .show {
    display: block;
  }

  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }

  .watch {
    text-align: center;
  }

  #watch-background {
    background-color: black;
    width: 144px;
    height: 168px;
    padding: 0px;
    margin: 0px;
    display: inline-block;
  }

  #watch {
    background-color: black;
    opacity: 0.8;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>
      <div class='en'>11 Weeks Configuration</div>
      <div class='zh-Hans'>11周 表盘配置</div>
      <div class='zh-Hant'>11周 錶盤設定</div>
    </h1>

    <div class='item-container'>
      <div class='item-container-header'>
        <div class='en'>Preview</div>
        <div class='zh-Hans'>预览</div>
        <div class='zh-Hant'>預覽</div>
      </div>
      <div class='item-container-content watch'>
        <div class='item'>
          <div id='watch-background'>
            <canvas id='watch' width='144' height='168'>
              <div class='en'>I am sorry that the preview (using &lt;canvas&gt;) is not supported by your device.</div>
              <div class='zh-Hans'>很抱歉，您的设备不支持（使用了&lt;canvas&gt;的）预览。</div>
              <div class='zh-Hant'>很抱歉，您的設備不支持（使用了&lt;canvas&gt;的）預覽。</div>
            </canvas>
          </div>
        </div>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>
        <div class='en'>Optional Components</div>
        <div class='zh-Hans'>可选组件</div>
        <div class='zh-Hant'>可選部件</div>
      </div>
      <div class='item-container-content'>
        <label class='item'>
          <div class='en'>Seconds (refresh per sec)</div>
          <div class='zh-Hans'>记秒（需每秒刷新）</div>
          <div class='zh-Hant'>記秒（需每秒更新）</div>
          <input id='sec-layer' type='checkbox' class='item-toggle' checked='checked'>
        </label>
        <label class='item'>
          <div class='en'>Outline Frame (refresh per sec)</div>
          <div class='zh-Hans'>计时外框（需每秒刷新）</div>
          <div class='zh-Hant'>計時外框（需每秒更新）</div>
          <input id='frame-layer' type='checkbox' class='item-toggle' checked='checked'>
        </label>
        <label class='item'>
          <div class='en'>Pebble Battery</div>
          <div class='zh-Hans'>手表电量</div>
          <div class='zh-Hant'>手錶電量</div>
          <input id='battery-layer' type='checkbox' class='item-toggle' checked='checked'>
        </label>
        <label class='item'>
          <div class='en'>Phone Battery &amp; Bluetooth</div>
          <div class='zh-Hans'>手机电量与蓝牙</div>
          <div class='zh-Hant'>手機電量與藍牙</div>
          <input id='bt-phone-layer' type='checkbox' class='item-toggle' checked='checked'>
        </label>
      </div>
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SAVE' />
        <div id='submit_button-en' style='display:none;'>SAVE</div>
        <div id='submit_button-zh-Hans' style='display:none;'>保存</div>
        <div id='submit_button-zh-Hant' style='display:none;'>存儲</div>
      </div>
    </div>
  </body>
  <script>
  var keys = {
    'sec-layer': 1, 
    'frame-layer': 2,
    'battery-layer': 4,
    'bt-phone-layer': 8
  };
  function getConfigData(needSave) {

    var options = {};

    for (var key in keys) {
      var ctrl = document.getElementById(key);
      var value = ctrl.checked;
      options[key] = value;

      if (needSave) {
        // if need save, save for next launch
        if (!value) {
          localStorage.setItem(key, '1');
        } else {
          localStorage.removeItem(key);
        }
      }
    }

    // console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  function getConfigFlags() {
    var options = getConfigData(true);
    var config = 0;
    for (var key in keys) {
      if (!options[key]) {
        config |= keys[key];
      }
    }
    return {
      'config': config
    };
  }

  function drawWatch(canvas) {
    var canvas = document.getElementById('watch');
    images.init(function () {
      watch.getConfig = getConfigData;
      watch.setCanvas(canvas);
      watch.beginDraw();
    });
  }

  function getSupportedLanguage(lang) {
    var ret = 'en',
        hans = ['-hans', '-cn'], 
        i,
        isHans = false;
    if (lang) {
      lang = lang.toLowerCase();
      if (lang.startsWith('zh')) {
        for (i = 0; i < hans.length; i++) {
          if (lang.indexOf(hans[i]) >= 0) {
            isHans = true;
            break;
          }
        }

        ret = isHans ? 'zh-Hans' : 'zh-Hant';
      }
    }

    return ret;
  }

  function setUILanguage(lang) {
    lang = getSupportedLanguage(lang);
    var ctrls = {
      'submit_button': 'value'
    }, langClasses = [
      'en', 'zh-Hans', 'zh-Hant'
    ], lables, i, j, isSame;

    for (i = 0; i < langClasses.length; i++) {
      labels = document.getElementsByClassName(langClasses[i]);
      isSame = lang === langClasses[i];
      for (j = 0; j < labels.length; j++) {
        labels[j].classList.remove(isSame ? 'hide' : 'show');
        labels[j].classList.add(isSame ? 'show' : 'hide');
      }
    }
    document.getElementsByTagName('html')[0].setAttribute('lang', lang);

    for (var c in ctrls) {
      var ctrl = document.getElementById(c);
      var div = document.getElementById(c + '-' + lang);
      if (ctrl && div) {
        ctrl[ctrls[c]] = div.innerHTML;
      }
    }
  }
 
  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');

    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigFlags()));
  });

  (function() {
    // Load any previously saved configuration, if available
    for (var key in keys) {
      var ctrl = document.getElementById(key);
      var value = localStorage[key];
      ctrl.checked = value ? false : true;
    }
    drawWatch();
    setUILanguage(navigator.language || navigator.userLanguage);
  })();
  </script>
</html>
